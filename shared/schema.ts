import { mysqlTable, varchar, int, boolean, text } from "drizzle-orm/mysql-core";
import { createInsertSchema } from "drizzle-zod";
import { z } from "zod";

export const users = mysqlTable("users", {
  id: int("id").primaryKey().autoincrement(),
  phone: varchar("phone", { length: 20 }).notNull().unique(),
  name: varchar("name", { length: 255 }),
  isAdmin: boolean("is_admin").notNull().default(false),
  createdAt: int("created_at").notNull().default(0),
  bonusBalance: int("bonus_balance").notNull().default(0), // Баланс дополнительной премии
});

export const workers = mysqlTable("workers", {
  id: int("id").primaryKey().autoincrement(),
  name: varchar("name", { length: 255 }).notNull(),
});

export const tasks = mysqlTable("tasks", {
  id: int("id").primaryKey().autoincrement(),
  title: varchar("title", { length: 255 }).notNull(),
  workerId: int("worker_id"),
  requiresPhoto: boolean("requires_photo").notNull().default(false),
  photoUrl: varchar("photo_url", { length: 500 }), // Устаревшее, для совместимости
  photoUrls: text("photo_urls"), // JSON массив URL фотографий (до 10 шт)
  examplePhotoUrl: varchar("example_photo_url", { length: 500 }), // Пример фото для задачи
  isCompleted: boolean("is_completed").notNull().default(false),
  weekDays: varchar("week_days", { length: 20 }), // JSON массив дней: [0,1,2,3,4,5,6] где 0=Вс, 1=Пн, ..., 6=Сб
  monthDay: int("month_day"), // День месяца (1-31) для отображения задачи
  isRecurring: boolean("is_recurring").notNull().default(true), // Повторяющаяся задача (сбрасывается каждый день)
  price: int("price").notNull().default(0), // Стоимость выполнения задачи в рублях
  category: varchar("category", { length: 100 }), // Категория задачи (уборка, готовка и т.д.)
  description: text("description"), // Описание задачи
});

export const insertUserSchema = z.object({
  phone: z.string().min(1, "Номер телефона обязателен").refine(
    (val) => {
      const normalized = val.replace(/\s+/g, "").replace(/-/g, "");
      // Проверяем формат: +7 и затем 9-10 цифр (для российских номеров)
      return /^\+7\d{9,10}$/.test(normalized);
    },
    "Неверный формат номера телефона (формат: +7XXXXXXXXX или +7XXXXXXXXXX)"
  ),
  name: z.string().optional(),
  isAdmin: z.boolean().optional().default(false),
});

export const updateUserSchema = z.object({
  phone: z.string().min(1, "Номер телефона обязателен").refine(
    (val) => {
      const normalized = val.replace(/\s+/g, "").replace(/-/g, "");
      return /^\+7\d{9,10}$/.test(normalized);
    },
    "Неверный формат номера телефона (формат: +7XXXXXXXXX или +7XXXXXXXXXX)"
  ),
  name: z.string().nullable().optional(),
});

export const loginSchema = z.object({
  phone: z.string().min(1, "Номер телефона обязателен").refine(
    (val) => {
      const normalized = val.replace(/\s+/g, "").replace(/-/g, "");
      // Проверяем формат: +7 и затем 9-10 цифр (для российских номеров)
      return /^\+7\d{9,10}$/.test(normalized);
    },
    "Неверный формат номера телефона (формат: +7XXXXXXXXX или +7XXXXXXXXXX)"
  ),
});

export const insertWorkerSchema = createInsertSchema(workers).pick({
  name: true,
});

export const insertTaskSchema = createInsertSchema(tasks).pick({
  title: true,
  workerId: true,
  requiresPhoto: true,
}).extend({
  photoUrl: z.string().nullable().optional(), // Устаревшее, для совместимости
  photoUrls: z.array(z.string()).nullable().optional(), // Массив URL фотографий (до 10 шт)
  examplePhotoUrl: z.string().nullable().optional(), // URL примера фото
  isCompleted: z.boolean().optional().default(false),
  weekDays: z.array(z.number().min(0).max(6)).nullable().optional(), // массив дней недели [0-6]
  monthDay: z.number().min(1).max(31).nullable().optional(), // день месяца (1-31)
  isRecurring: z.boolean().optional().default(true), // повторяющаяся задача
  price: z.number().min(0).optional().default(0), // стоимость выполнения в рублях
  category: z.string().max(100).nullable().optional(), // категория задачи
  description: z.string().nullable().optional(), // описание задачи
});

export type User = typeof users.$inferSelect;
export type InsertUser = z.infer<typeof insertUserSchema>;
export type UpdateUser = z.infer<typeof updateUserSchema>;
export type LoginInput = z.infer<typeof loginSchema>;
export type Worker = typeof workers.$inferSelect;
export type InsertWorker = z.infer<typeof insertWorkerSchema>;
// Переопределяем Task чтобы weekDays и photoUrls были массивами (парсятся из JSON в storage.ts)
export type Task = Omit<typeof tasks.$inferSelect, 'weekDays' | 'photoUrls'> & {
  weekDays: number[] | null;
  photoUrls: string[];
};
export type InsertTask = z.infer<typeof insertTaskSchema>;
